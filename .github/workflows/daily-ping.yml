name: Weekly & Monthly & Daily Ping Remind Service

on:
  schedule:
    # WARMUP (20 minutes before) - DAILY: 13:35 VN = 06:35 UTC
    - cron: "35 6 * * *"
    # MAIN DAILY - 13:55 VN = 06:55 UTC
    - cron: "55 6 * * *"

    # WARMUP (20m) - WEEKLY: Sun 19:35 VN = Sun 12:35 UTC
    - cron: "35 12 * * 0"
    # MAIN WEEKLY - Sun 19:55 VN = Sun 12:55 UTC
    - cron: "55 12 * * 0"

    # WARMUP (20m) - MONTHLY CHECK: 07:35 VN = 00:35 UTC
    - cron: "35 0 * * *"
    # MAIN MONTHLY CHECK - 07:55 VN = 00:55 UTC
    - cron: "55 0 * * *"
    
  workflow_dispatch: {}

env:
  BASE_URL: "https://remind-service.onrender.com"
  DAILY_PATH: "/"
  WEEKLY_PATH: "/debug/run_weekly"
  MONTHLY_PATH: "/debug/run_monthly"
  HEALTH_PATH: "/health"
  CURL_OPTS: "-sS -L --max-time 120 --retry 3 --retry-delay 5 -w '\\nHTTP_CODE:%{http_code}\\n'"

jobs:
  ping_jobs:
    runs-on: ubuntu-latest
    steps:
      - name: Show UTC time
        run: date -u

      - name: Wake Render /health
        run: |
          echo "Waking Render..."
          for i in 1 2 3; do
            echo "Wake attempt #$i"
            curl -v --max-time 15 "$BASE_URL$HEALTH_PATH" || true
            sleep 3
          done
          echo "Warm-up wait..."
          sleep 8

      - name: Daily ping (13:55 VN)
        run: |
          HOUR=$(date -u +%H); MIN=$(date -u +%M)
          if [ "$HOUR" = "06" ] && [ "$MIN" = "55" ]; then
            echo "Running DAILY ping..."
            curl -v $CURL_OPTS "$BASE_URL$DAILY_PATH"
          else
            echo "Skip daily"
          fi

      - name: Weekly ping (Sunday 19:55 VN)
        run: |
          HOUR=$(date -u +%H); MIN=$(date -u +%M); DOW=$(date -u +%u)
          if [ "$DOW" = "7" ] && [ "$HOUR" = "12" ] && [ "$MIN" = "55" ]; then
            echo "Running WEEKLY ping..."
            curl -v $CURL_OPTS "$BASE_URL$WEEKLY_PATH"
          else
            echo "Skip weekly"
          fi

      - name: Monthly ping (last day 07:55 VN)
        run: |
          HOUR=$(date -u +%H); MIN=$(date -u +%M)
          if [ "$HOUR" = "00" ] && [ "$MIN" = "55" ]; then
            TOMORROW=$(date -u -d "tomorrow" +%d)
            if [ "$TOMORROW" = "01" ]; then
              echo "Running MONTHLY ping..."
              curl -v $CURL_OPTS "$BASE_URL$MONTHLY_PATH"
            else
              echo "Not last day â€” skip monthly"
            fi
          else
            echo "Skip monthly time check"
          fi
